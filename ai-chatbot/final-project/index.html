<!doctype html>
<html lang="en">
  <head>
    <title>AI Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        background-color: black;
        color: white;
        min-height: 100vh;
        font-family: sans-serif;
      }

      main {
        position: relative;
        z-index: 1;
        height: 100vh;
      }

      #messages {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 24px 8px 40px;
      }

      .assistant-message,
      .user-message {
        display: inline-flex;
        background: gainsboro;
        color: black;
        padding: 8px 8px;
        border-radius: 4px;
        max-width: 80%;
      }
      
      .assistant-message {
        margin-right: auto;
      }

      .user-message {
        margin-left: auto;
      }

      #chat-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 4px;
        padding: 0 8px 4px;
      }

      #chat-input {
        flex-grow: 1;
        padding: 4px;
        border-radius: 4px;
      }

      #send-button {
        padding: 4px;
      }

      #open-menu {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
      }

      #menu-panel {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 160px;
        z-index: 0;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="messages">
      </div>
      <div id="chat-bar">
        <input id="chat-input">
        <button id="send-button">send</button>
      </div>
    </main>
    <aside id="menu">
      <div id="open-menu">menu</div>    
      <div id="menu-panel">
        menu
      </div>
    </aside>

    <script>
      const addMessage = (message) => {
        // create message div
        const messageDiv = document.createElement('div')
        messageDiv.classList.add(message.role === 'assistant' ? 'assistant-message' : 'user-message')
        messageDiv.innerText = message.content

        // append message div to messages
        messagesDiv.appendChild(messageDiv)
      }

      // send new message to AI
      // input: the input element used to send the message
      // messages: the array of messages
      const sendMessage = async (input, messages) => {
        const inputValue = input.value

        // if no text in input, don't send
        if (!inputValue) return
        
        // new message
        const message = {
          role: 'user',
          content: input.value
        }

        // add to messages list
        messages.push(message)

        // add new message to messages div
        addMessage(message)

        // clear input
        input.value = ''

        // save messages in local storage
        localStorage.setItem('messages', JSON.stringify(messages))

        // send the query to the AI model
        const assistantResponse = await fetch('http://localhost:8081/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'qwen2.5:0.5b',
            messages: messages,
            stream: false
          })
        });

        // parse reponse to JS object
        const assistantData = await assistantResponse.json()
        const assistantMessage = assistantData.message
        
        // add assistant message to messages list
        messages.push(assistantMessage)
        addMessage(assistantMessage)
        localStorage.setItem('messages', JSON.stringify(message))
      }

      // array containing all the messages of the conversation
      const messages = localStorage.getItem('messages')
        ? JSON.parse(localStorage.getItem('messages'))
        : []

      // elements
      const messagesDiv = document.body.querySelector('#messages')
      const chatInput = document.body.querySelector('#chat-input')
      const sendButton = document.body.querySelector('#send-button')

      // generate the divs of all the messages in the conversation
      for (const message of messages) {
        addMessage(message)
      }

      // when click send button, send new user message
      sendButton.addEventListener('click', () => {
        sendMessage(chatInput, messages)
      })
    </script>
  </body>
</html>
